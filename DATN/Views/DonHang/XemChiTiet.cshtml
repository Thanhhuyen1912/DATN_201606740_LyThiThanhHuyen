@{
    ViewData["Title"] = "Chi tiết đơn hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using System.Globalization
@{
    var culture = new CultureInfo("vi-VN");
}
@model CoreLib.DTO.NdChitiet
<div>
    <div class="col-md-12 d-flex">
        <div style="margin: 0 auto">
            <h3 style="font-size: 22px; text-align: center" class="mt-2 mb-3">Thông tin đặt hàng</h3>
            <!-- Product Name Field -->
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Họ tên người đặt</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="thoten" value="@Model.taikhoan.HoTen" readonly />
                </div>
            </div>
            <!-- Product Price Field -->
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label" for="temail">Email</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="temail" value="@Model.taikhoan.Email" readonly />
                </div>
            </div>
            <div class="form-group row nopadding mt-2" hidden>
                <div class="col-md-6">
                    <label class="col-form-label"></label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="tmadonhang" readonly />
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Trạng thái vận chuyển</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="temail" value="@Model.dh.TrangThaiVanChuyen" readonly />
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Phương thức thanh toán</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="tptthanhtoan" value="@Model.phuongthucthanhtoan" readonly />
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Trạng thái thanh toán</label>
                </div>
                <div class="col-md-6">
                    <input type="text"  style="font-size: 15px" class="form-control" id="tptthanhtoan" value="@Model.ttthanhtoan" readonly/>
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Số tiền giảm giá</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="ttiengiam" value="@Model.giamgia.ToString("N0")đ" readonly>
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Tiền vận chuyển</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="ttiengiam" value="30.000đ"  readonly />
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Thành tiền</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="tthanhtien" value="@Model.dh.TongTien.ToString("N0")đ" readonly>
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Ngày đặt hàng</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="tthanhtien" value="@Model.dh.NgayTao" readonly>
                </div>
            </div>
        </div>
        <div style="margin: 0 auto">
            <h3 style="font-size: 22px; text-align: center" class="mt-2 mb-3">Thông tin nhận hàng</h3>

            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Tên người nhận</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="ttennguoinhan" value="@Model.diachi.HoTenNguoiNhan" readonly>
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Số điện thoại nhận</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="tsdtnhan" value="@Model.diachi.SoDienThoaiNguoiNhan" readonly>
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Thành phố</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="tthanhpho" value="@Model.diachi.ThanhPho" readonly>
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Huyện</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="thuyen" value="@Model.diachi.Huyen" readonly>
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Xã</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="txa" value="@Model.diachi.Xa" readonly>
                </div>
            </div>
            <div class="form-group row nopadding mt-2">
                <div class="col-md-6">
                    <label class="col-form-label">Chi tiết</label>
                </div>
                <div class="col-md-6">
                    <input type="text" style="font-size: 15px" class="form-control" id="tchitiet" value="@Model.diachi.ChiTiet" readonly>
                </div>
            </div>
        </div>
    </div>
</div>
<div style="margin: 10px auto; font-size:22px; text-align: center;">
    <p>Danh sách sản phẩm mua</p>
</div>
<table id="donmuaTable" class="table table-bordered table-sm">
    <thead>
        <tr>
            <th class="tt" style="width: 180px; cursor: pointer;" onclick="sortTable(0)">Tên sản phẩm</th>
            <th class="tt" style="width: 130px; cursor: pointer;" onclick="sortTable(1)">Giá tiền</th>
            <th class="tt" style="width: 120px; cursor: pointer;" onclick="sortTable(2)">Giảm giá</th>
            <th class="tt" style="width: 50px; cursor: pointer;" onclick="sortTable(3)">Số lượng</th>
            <th class="tt" style="width: 140px; cursor: pointer;" onclick="sortTable(4)">Tổng tiền</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model.chitiet)
        {
            <tr style="font-size:15px">
                <td>@item.TenSanPham</td>
                <td>@item.GiaTien.ToString("C0", culture)</td>
                <td>@item.GiaGiam.ToString("C0", culture)</td>
                <td>@item.SoLuong</td>
                <td>@item.TongTien.ToString("C0", culture)</td>
                @{
                    var daDanhGia = Model.danhgia.Where(d => d.MaSanPham == item.MaSanPham && d.MaTaiKhoan == Model.mataikhoan).FirstOrDefault();
                }
                @if (Model.dh.TrangThaiVanChuyen == "Đã vận chuyển" && daDanhGia == null)
                {
                    <td width="50px">
                        <a href="/DonHang/DanhGia?id=@item.MaSanPham">
                            <i class="bi bi-star"></i>
                        </a>
                    </td>

                }
            </tr>
        }
    </tbody>
</table>


<style>
    .tt {
        color: #a75851;
    }

    /* Căn giữa nội dung các ô */
    #donmuaTable th, #donmuaTable td {
        text-align: center;
        vertical-align: middle;
        padding: 7px;
    }

    /* Màu chữ tiêu đề bảng */
    #donmuaTable thead th {
        color: #a75851; /* Màu xanh dương Bootstrap */
        font-weight: bold;
    }

    .btncapnhat {
        background-color: #fdb9a4;
        color: #a75851;
        padding: 7px;
        border-radius: 4px;
        display: block;
        text-align: center;
    }

        .btncapnhat:hover {
            background-color: #fdb9a4;
            color: #a75851;
        }

    /* Tuỳ chọn thêm: bo tròn góc nút và padding */

</style>
<!-- Nút phân trang -->
<div id="pagination" class="mt-3 text-center" style="justify-content:right"></div>


<div style="display: flex; justify-content: center; margin-top: 20px;">
    <a href="/DonHang/DonMua" class="btncapnhat">Quay lại</a>
</div>

<script>



    document.addEventListener("DOMContentLoaded", function () {
        const table = document.getElementById("donmuaTable");
        const tbody = table.querySelector("tbody");
        const rows = tbody.querySelectorAll("tr");
        const rowsPerPage = 10;
        const totalPages = Math.ceil(rows.length / rowsPerPage);
        const pagination = document.getElementById("pagination");

        function showPage(page) {
            // Ẩn tất cả các hàng
            rows.forEach((row, index) => {
                row.style.display = "none";
            });

            // Hiển thị hàng thuộc trang hiện tại
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            for (let i = start; i < end && i < rows.length; i++) {
                rows[i].style.display = "";
            }

            // Tô đậm nút đang được chọn
            const buttons = pagination.querySelectorAll("button");
            buttons.forEach(btn => btn.classList.remove("active"));
            if (buttons[page - 1]) buttons[page - 1].classList.add("active");
        }

        function createPagination() {
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.className = "btn btn-sm  mx-1";
                   btn.style.color = "#a75851";
                   btn.style.backgroundColor = "#fdb9a4";

                btn.addEventListener("click", function () {
                    showPage(i);
                });
                pagination.appendChild(btn);
            }
        }

        if (rows.length > 0) {
            createPagination();
            showPage(1);
        }
    });

    let sortDirection = {}; // theo dõi chiều sắp xếp từng cột

    function sortTable(columnIndex) {
        const table = document.getElementById("donmuaTable");
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);

        // Xác định kiểu dữ liệu (số hay chữ)
        const isNumeric = columnIndex === 2; // Cột "Tổng tiền"

        // Đảo chiều nếu đã sắp xếp rồi
        sortDirection[columnIndex] = !sortDirection[columnIndex];

        rows.sort((a, b) => {
            let valA = a.cells[columnIndex].innerText.trim();
            let valB = b.cells[columnIndex].innerText.trim();

            if (isNumeric) {
                valA = parseInt(valA.replace(/\D/g, '')) || 0;
                valB = parseInt(valB.replace(/\D/g, '')) || 0;
            } else {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }

            if (valA < valB) return sortDirection[columnIndex] ? -1 : 1;
            if (valA > valB) return sortDirection[columnIndex] ? 1 : -1;
            return 0;
        });

        // Cập nhật lại thứ tự hàng trong tbody
        rows.forEach(row => tbody.appendChild(row));
    }
</script>