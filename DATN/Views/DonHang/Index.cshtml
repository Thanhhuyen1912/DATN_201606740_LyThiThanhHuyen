@{
    ViewData["Title"] = "Danh sách đơn hàng";
    Layout = "~/Views/Shared/_Layout1.cshtml";
}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.datatables.net/2.2.1/js/dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/2.2.1/css/dataTables.dataTables.min.css" />

<div id="loading" class="loading" style="display: none;">Đang tải...</div>
<div class="container" id="noidung">
    <div class="gsm-daihoi-info">
        <div style=" color: #a75851" class="row justify-content-center" id="tt">
            <span style=" color: #a75851" class="col-12 text-center p-1 titlediv">Danh sách đơn hàng</span>
        </div>
        <div style=" color: #a75851; display: none" class="row justify-content-center" id="tt1">
            <span style=" color: #a75851" class="col-12 text-center p-1 titlediv">Danh sách sản phẩm mua</span>
        </div>
    </div>
    <div class="k-portlet__body mt-3">
        <ul class="nav nav-pills nav-tabs-btn nav-pills-btn-success row" role="tablist">
            <li id="tt10" style="background-color: #fdb9a4; color: #a75851; border-radius:10%" class="nav-item col gsm-link-tab">
                <a style="background-color: #fdb9a4; color: #a75851" class="nav-link active show" data-toggle="tab" href="#subjectListTab" role="tab" aria-selected="true">
                    <span id="tt2" style="background-color: #fdb9a4; color: white;" class=" text-uppercase">
                        Danh sách đơn hàng
                    </span>
                    <span id="tt11" style="background-color: #fdb9a4; color: white; display: none" class=" text-uppercase">
                        Danh sách sản phẩm mua
                    </span>
                </a>
            </li>
            <li id="tt123" style=" color: #a75851; display: none" class="nav-item col gsm-link-tab">
                <a style=" color: #a75851" class="nav-link custom-tab-link" data-toggle="tab" href="#subjectFormTab" role="tab" aria-selected="false">
                    <span class="nav-link-title text-uppercase " id="formTabTitle">Chi tiết</span>
                </a>
            </li>
        </ul>

        <div style="background-color: #fdb9a4; color: #a75851" class="line_top col-md-12"></div>

        <div class="tab-content">

            <!-- Subject List Tab -->
            <div class="tab-pane fade show active " id="subjectListTab">

                <div class="form-group row nopadding col-12 form10">
                    <!-- Product Name Field -->
                    <div class="form-group col-md-3">
                        <label class="col-form-label">Trạng thái vận chuyển</label>
                        <select class="form-control" id="strangthaivanchuyen">
                            <!-- Các option sẽ được thêm vào đây -->
                        </select>
                    </div>
                    <!-- Product Category Field -->
                    <div class="form-group col-md-3">
                        <label class="col-form-label" for="shinhthucvanchuyen">Hình thức vận chuyển</label>
                        <select class="form-control" id="shinhthucvanchuyen">
                            <!-- Các option sẽ được thêm vào đây -->
                        </select>
                    </div>
                    <div class="form-group col-md-2">
                        <label class="col-form-label" for="strangthaithanhtoan">Trạng thái thanh toán</label>
                        <select class="form-control" id="strangthaithanhtoan">
                            <!-- Các option sẽ được thêm vào đây -->
                        </select>
                    </div>
                    <div class="form-group col-md-2">
                        <label class="col-form-label" for="sngaydau">Từ ngày</label>
                        <input type="date" class="form-control" id="sngaydau">
                    </div>
                    <div class="form-group col-md-2">
                        <label class="col-form-label" for="sngaycuoi">Đến ngày</label>
                        <input type="date" class="form-control" id="sngaycuoi">
                    </div>

                </div>

                <div class="form-group row">
                    <div class="row justify-content-center col-12">
                        <button style="background-color: #fdb9a4; color: #a75851" type="submit" class="btn btn-primary mz-3 col-md-2 col-sm-12" id="searchButton">
                            Tìm kiếm
                        </button>
                        <button style="background-color: #fdb9a4; color: #a75851; display: none" type="submit" class="btn btn-primary mz-3 col-md-2 col-sm-12" id="backbutton">
                            Quay lại
                        </button>
                    </div>
                </div>
                <div class=" justify-content-start mb-2">
                    <button id="backbt" class="btn btn-secondary">Tải lại</button>
                </div>

                <!-- Add custom sort button here -->
                <table id="listGrid" class="display mt-3" style="width: 100%;">

                    <thead style="height:50px;font-size:17px">
                        <tr>
                            <th>Họ tên</th>
                            <th>Vận chuyển</th>
                            <th>Chiết khấu</th>
                            <th>Thành tiền</th>
                            <th>PT thanh toán</th>
                            <th>TT thanh toán</th>
                            <th>Ngày tạo</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <table id="listGrid1" class="mt-3" style="width: 100%; display: none">

                    <thead style="height:50px;font-size:17px">
                        <tr>
                            <th>Tên sản phẩm</th>
                            <th>Giá tiền</th>
                            <th>Giá giảm</th>
                            <th>Số lượng</th>
                            <th>Tổng tiền</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Add/Edit Product Form Tab (Unified for Create/Edit) -->
            <div class="tab-pane fade boxshadow pt-2" id="subjectFormTab" role="tabpanel">
                <div class="form-group row nopadding">
                    <form id="SubjectForm" class="col-12 ">
                        <input type="hidden" class="form-control" id="">
                        @* <!-- Product Id Field --> *@
                        <div class="col-md-12 form1">
                            <!-- Product Name Field -->
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Họ tên người đặt</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="thoten" readonly>
                                </div>
                            </div>
                            <!-- Product Price Field -->
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label" for="temail">Email</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="temail" readonly />
                                </div>
                            </div>
                            <div class="form-group row nopadding" hidden>
                                <div class="col-md-3">
                                    <label class="col-form-label"></label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="tmadonhang" readonly>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Trạng thái vận chuyển</label>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-control" id="tttvanchuyen">
                                        <!-- Các option sẽ được thêm vào đây -->
                                    </select>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Phương thức thanh toán</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="tptthanhtoan" readonly>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Trạng thái thanh toán</label>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-control" id="tttthanhtoan">
                                    </select>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Tổng tiền</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="ttongtien" readonly>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Tiền vận chuyển</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="tienvanchuyen" readonly>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Số tiền giảm giá</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="ttiengiam" readonly>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Thành tiền</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="tthanhtien" readonly>
                                </div>
                            </div>
                            <div style="margin: 0 auto">
                                <h3>Thông tin nhận hàng</h3>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Tên người nhận</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="ttennguoinhan" readonly>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Số điện thoại nhận</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="tsdtnhan" readonly>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Thành phố</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="tthanhpho" readonly>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Huyện</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="thuyen" readonly>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Xã</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="txa" readonly>
                                </div>
                            </div>
                            <div class="form-group row nopadding">
                                <div class="col-md-3">
                                    <label class="col-form-label">Chi tiết</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="tchitiet" readonly>
                                </div>
                            </div>

                        </div>
                    </form>
                </div>

                <!-- Button Group -->
                <div class="form-group row">
                    <div class="form3 row justify-content-center col-12">
                        <button style="background-color: #fdb9a4;display:none;" type="button" class="btn btn-primary mz-3 col-md-2 col-sm-12" id="Update">
                            Cập nhật
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
                               $(document).ready(function () {
                                    $('#shinhthucvanchuyen').append(
                                        `<option value="">----</option>`
                                    );
                    $.ajax({
                        url: 'http://localhost:7177/PhuongThuc/Danhsach',
                        method: 'GET',
                        success: function (res) {
                            if (Array.isArray(res.data)) {
                                res.data.forEach(function (item) {
                                    $('#shinhthucvanchuyen').append(
                                        `<option value="${item.maPhuongThuc}">${item.tenPhuongThuc}</option>`
                                    );
                                });
                            }
                        },
                        error: function (err) {
                            console.error("Lỗi khi lấy danh sách phương thức vận chuyển:", err);
                        }
                    });
                });


                 $(document).ready(function () {
                             $('#tt10').on('click', function () {
                                 $('#tt123').hide();
                             });
                  });
                 $(document).ready(function () {

                                    let trangThaiOptions = [
                                    { value: "Chờ xác nhận", text: "Chờ xác nhận" },
                                    { value: "Đang vận chuyển", text: "Đang vận chuyển" },
                                    { value: "Đã vận chuyển", text: "Đã vận chuyển" },
                                    { value: "Đã hủy", text: "Đã hủy" }
                                    ];

                                    let select = $("#strangthaivanchuyen");
                                    let select1 = $("#tttvanchuyen");
                                    select.append(`<option value="">---</option>`);
                                    trangThaiOptions.forEach(function (item) {
                                    select.append(`<option value="${item.value}">${item.text}</option>`);
                                    select1.append(`<option value="${item.value}">${item.text}</option>`);
                                    });
                                    });
                    // load dropdownlist trangthai
                            $(document).ready(function () {

                                    let trangThaiOptions = [
                                    { value: true, text: "Đã thanh toán" },
                                    { value: false, text: "Chưa thanh toán" }
                                    ];

                                    let select = $("#strangthaithanhtoan");
                                    let select1 = $("#tttthanhtoan");
                                    select.append(`<option value="">---</option>`);
                                    trangThaiOptions.forEach(function (item) {
                                    select.append(`<option value="${item.value}">${item.text}</option>`);
                                    select1.append(`<option value="${item.value}">${item.text}</option>`);
                                    });
                                    });
                    // select datepicker
                             $(document).ready(function () {
                                     $('#tt10').show();
                                     $('#tt11').hide();
                             });
                             $(document).ready(function () {
                     // Load initial data
                                      loadGridData();
                     // Function to load data into the grid
                                      function loadGridData() {
                                              var url = "http://localhost:7177/DonHang/Danhsach";
                                              $.get(url, {}, function (response) {
                                              var dulieu = response.data || [];
                                              dulieu.sort((a, b) => new Date(b.NgayTao) - new Date(a.NgayTao));
                                     // Khởi tạo hoặc cập nhật DataTable
                                              $('#listGrid').DataTable({
                                                 dom: '<"top"f>rt<"bottom"ip><"clear">',
                                                 destroy: true,
                                                 lengthChange: true,
                                                 autoWidth: false,
                                                 searching: false,
                                                 ordering: true,
                                                 paging: true,
                                                 data: dulieu,
                                                 columns: [
                                                                 { "data": "tenDatMua", "width": "10%" },
                                                                 { "data": "trangThaiVanChuyen", "width": "12%" },
                                                                        {
                  data: "soTienGiam",
                  width: "11%",
                  render: function (data, type, row) {
                      let formatted = "";
                   return formatted = parseFloat(data).toLocaleString("vi-VN", { style: "currency", currency: "VND" });
                  }
                },


                                                                 { "data": "thanhTien", "width": "11%",
                                                                  render: function (data, type, row) {
                      let formatted = "";
                     return formatted = parseFloat(data).toLocaleString("vi-VN", { style: "currency", currency: "VND" });
                  }
                                                                 },
                                                                 { "data": "phuongthucthanhtoan", "width": "17%" },
                                                                  {
                                                                     data: "trangThaiThanhToan",
                                                                     width: "15%",
                                                                     render: function (data, type, row) {
                                                                     return data === true ? "Đã thanh toán" : "Chưa thanh toán";
                                                                     }
                                                                 },
                                                                              {
                  data: "ngayTao",  // giữ nguyên kiểu DateTime
                  width: "13%",
                  render: function (data, type, row) {
                    if (!data) return "";

                    // Khi sắp xếp, trả về data gốc để đảm bảo đúng kiểu
                    if (type === "sort" || type === "type") {
                      return data;
                    }

                    const date = new Date(data);
                    const pad = n => n.toString().padStart(2, '0');
                    return pad(date.getDate()) + "/" +
                           pad(date.getMonth() + 1) + "/" +
                           date.getFullYear() + " " +
                           pad(date.getHours()) + ":" +
                           pad(date.getMinutes()) + ":" +
                           pad(date.getSeconds());
                  }
                }
                ,

                                                                 {
                                                                     "data": "maDonHang",
                                                                     "width":"16%",
                                                                     render: function (data) {
                                                                     let editButton = `
                                                                     <button class='ViewDetails btn btn-link' data-id="${data}">
                                                                     <i class="bi bi-pencil-fill"></i>
                                                                     </button>`;

                                                                     let DetailsButton = `
                                                                     <button class='DeleteSubject btn btn-link' data-id="${data}">
                                                                     <i class="bi bi-list"></i>
                                                                     </button>`;
                                                                      let PdfButton = `
                                                                     <button class='Viewpdf btn btn-link' data-id="${data}">
                                                                    <i class="bi bi-file-earmark-pdf-fill"></i>
                                                                     </button>`;
                                                                     return editButton + DetailsButton + PdfButton;
                                                                     }
                                                                     }
                                                 ],
                                                 language: {
                                                          search: "Tìm kiếm:",
                                                          info: "Hiển thị từ _START_ đến _END_ của _TOTAL_ đơn hàng",
                                                          zeroRecords: "Không tìm thấy kết quả nào."
                                                 }
                                              });

                                              $('#alphabetSortBtn').off('click').on('click', function () {
                                                 let table = $('#listGrid').DataTable();
                                                 let currentOrder = table.order();
                                                 if (currentOrder[0][0] === 1 && currentOrder[0][1] === 'asc') {
                                                     table.order([1, 'desc']).draw();
                                                 } else {
                                                     table.order([1, 'asc']).draw();
                                                 }
                                              });
                                              })
                                              .fail(function () {
                                              alert("Có lỗi xảy ra khi tải dữ liệu.");
                                              });
                                      }
                     // quay lại màn hình danh sách sp
                                       $('#backbt').click(function () {
                                              loadGridData();
                                              $("#strangthaivanchuyen").val('');
                                              $("#shinhthucvanchuyen").val('');
                                              $("#strangthaithanhtoan").val('');
                                              $("#sngaydau").val('');
                                              $("#sngaycuoi").val('');
                                      });
                     // Back main form
                                      $('#backbutton').click(function () {
                                                $('#listGrid1').hide();
                                                $('#listGrid1_filter').hide();
                                                $('#listGrid1_info').hide();
                                                $('#listGrid1_paginate').hide();
                                                $('#backbutton').hide();
                                                $('#listGrid').show();
                                                $('#listGrid_filter').show();
                                                $('#listGrid_info').show();
                                                $('.form1').show();
                                                $('.form2').hide();
                                                $('#listGrid_paginate').show();
                                                $('#tt10').show();
                                                $('#tt2').show();
                                                $('#tt11').hide();
                                                $('#tt123').hide();
                                                $('#backbt').show();
                                                $('#backbt1').hide();
                                                $('.form3').show();
                                                $('#tt11').hide();
                                                $('#Insert').show();
                                                $('.form10').show();
                                                $('.form11').hide();
                                                $('#searchButton').show();
                                                sessionStorage.removeItem("madonhang");
                                      });
                var cityList = [];
                var districtList = [];
                var wardList = [];

                $(document).ready(function () {
                    // Gọi API lấy danh sách tỉnh
                    $.ajax({
                        url: 'https://provinces.open-api.vn/api/p/',
                        method: 'GET',
                        success: function (data) {
                            cityList = data;
                            // Gọi API lấy tất cả huyện (d/): https://provinces.open-api.vn/api/d/
                            $.ajax({
                                url: 'https://provinces.open-api.vn/api/d/',
                                method: 'GET',
                                success: function (data) {
                                    districtList = data;
                                    // Gọi API lấy tất cả xã (w/): https://provinces.open-api.vn/api/w/
                                    $.ajax({
                                        url: 'https://provinces.open-api.vn/api/w/',
                                        method: 'GET',
                                        success: function (data) {
                                            wardList = data;
                                        },
                                        error: function () {
                                            console.log("Lỗi khi tải danh sách xã");
                                        }
                                    });
                                },
                                error: function () {
                                    console.log("Lỗi khi tải danh sách huyện");
                                }
                            });
                        },
                        error: function () {
                            console.log("Lỗi khi tải danh sách tỉnh");
                        }
                    });
                });


                     // View product details
                    $(document).on('click', '.ViewDetails', function () {
                    const table = $('#listGrid').DataTable();
                    const row = $(this).closest('tr');
                    const rowData = table.row(row).data();
                    const id = rowData.maDonHang;
                    $('#tt123').show();
                    // Gọi API lấy chi tiết tài khoản
                    $.ajax({
                        url: `http://localhost:7177/DonHang/ChiTiet?madh=${id}`,
                        type: 'GET',
                        success: function (response) {
                            if (!response || !response.data) {
                                alert('Chi tiết đơn hàng không tìm thấy.');
                                return;
                            }
                            console.log(response);
                          const data = response.data;
                          var tienvanchuyen = 30000;
                          var cityName = cityList.find(city => city.code == parseInt(data.diaChiTP));
                          var nameTP = cityName ? cityName.name : 'Không tìm thấy';

                          var dictrictName = districtList.find(city => city.code == parseInt(data.diaChiHuyen));
                          var nameHuyen = dictrictName ? dictrictName.name : 'Không tìm thấy';

                          var wardName = wardList.find(city => city.code == parseInt(data.diaChiXa));
                          var nameXa = wardName ? wardName.name : 'Không tìm thấy';
                          console.log(data.thanhTien);
                            // Gán dữ liệu vào form
                            $("#thoten").val(data.tenDatMua);
                            $("#temail").val(data.mail);
                            $("#tmadonhang").val(data.maDonHang);
                            $("#tttvanchuyen").val(data.trangThaiVanChuyen);
                            $("#tptthanhtoan").val(data.phuongthucthanhtoan);
                            $("#tttthanhtoan").val(data.trangThaiThanhToan.toString());
                            $("#ttiengiam").val(data.soTienGiam.toLocaleString("vi-VN", { style: "currency", currency: "VND" }));
                            $("#ttongtien").val(data.tongTien.toLocaleString("vi-VN", { style: "currency", currency: "VND" }));
                            $("#tthanhtien").val(data.thanhTien.toLocaleString("vi-VN", { style: "currency", currency: "VND" }));
                            $("#tienvanchuyen").val(tienvanchuyen.toLocaleString("vi-VN", { style: "currency", currency: "VND" }));
                            $("#ttennguoinhan").val(data.tenNhanHang);
                            $("#tsdtnhan").val(data.sdtNhanHang);
                            $("#tthanhpho").val(nameTP);
                            $("#thuyen").val(nameHuyen);
                            $("#txa").val(nameXa);
                            $("#tchitiet").val(data.diaChiChiTiet);

                            // Hiển thị tab form
                            $('#Update').show();
                            $('#formTabTitle').text('Chi tiết');
                            $('a[href="#subjectFormTab"]').tab('show');
                        },
                        error: function () {
                            alert('Lỗi khi lấy chi tiết danh sách sản phẩm mua.');
                        }
                    });
                });



                     // fill data in listGrid1
                                      function loadChiTietSanPham(madh) {
                                                        $.ajax({
                                                        url: `http://localhost:7177/DonHang/DanhSachSP?madonhang=${madh}`,
                                                        type: 'GET',
                                                        success: function (response) {
                                                        if (response && response.data && response.data.length > 0) {
                                                        let dulieu = response.data;
                                                        console.log(dulieu);
                                                        $('#listGrid1').DataTable({
                                                        dom: '<"top"f>rt<"bottom"ip><"clear">',
                                                        destroy: true,
                                                        lengthChange: true,
                                                        autoWidth: false,
                                                        searching: false,
                                                        ordering: true,
                                                        paging: true,
                                                        data: dulieu,
                                                        columns: [
                                                            { data: "tenSanPham", width: "20%" },
                                                              { "data": "giaTien", "width": "20%",
                                                                  render: function (data, type, row) {
                      let formatted = "";
                     return formatted = parseFloat(data).toLocaleString("vi-VN", { style: "currency", currency: "VND" });
                  }
                                                                 },
                                                              { "data": "giaGiam", "width": "20%",
                                                                  render: function (data, type, row) {
                      let formatted = "";
                     return formatted = parseFloat(data).toLocaleString("vi-VN", { style: "currency", currency: "VND" });
                  }
                                                                 },
                                                            { data: "soLuong", width: "20%" },
                                                             { "data": "tongTien", "width": "20%",
                                                                  render: function (data, type, row) {
                      let formatted = "";
                     return formatted = parseFloat(data).toLocaleString("vi-VN", { style: "currency", currency: "VND" });
                  }
                                                                 },

                                                        ],
                                                        language: {
                                                        search: "Tìm kiếm:",
                                                        info: "Hiển thị từ _START_ đến _END_ của _TOTAL_ sản phẩm",
                                                        zeroRecords: "Không tìm thấy kết quả nào."
                                                        }
                                                        });
                                                        } else {
                                    // Không có dữ liệu: reset bảng và xoá sessionStorage
                                                        if ($.fn.DataTable.isDataTable('#listGrid1')) {
                                                        $('#listGrid1').DataTable().clear().draw();
                                                        }
                                                        }
                                                        },
                                                        error: function () {

                                                        }
                                                        });
                                      }

                     // Details List products
                                      $(document).on('click', '.DeleteSubject', function () {
                                                        $('#listGrid').hide();
                                                        $('#listGrid_filter').hide();
                                                        $('#listGrid_info').hide();
                                                        $('#listGrid_paginate').hide();
                                                        $('#listGrid1').show();
                                                        $('#backbutton').show();
                                                        $('#listGrid1_filter').show();
                                                        $('#listGrid1_info').show();
                                                        $('#listGrid1_paginate').show();
                                                        $('.form2').show();
                                                        $('.form4').show();
                                                        $('.form1').hide();
                                                        $('.form3').hide();
                                                        $('#tt2').hide();
                                                        $('#tt').hide();
                                                        $('#tt10').show();
                                                        $('#tt10').show();
                                                        $('#tt1').show();
                                                        $('#tt11').show();
                                                        $('#tt123').hide();
                                                        $('#backbt1').show();
                                                        $('#backbt').hide();
                                                        $('.form11').show();
                                                        $('.form10').hide();
                                                        $('#searchButton1').show();
                                                        $('#searchButton').hide();
                                                        let table = $('#listGrid').DataTable();
                                                        let row = $(this).closest('tr');
                                                        let rowData = table.row(row).data();
                                                        let id = rowData.maDonHang;
                                                        sessionStorage.setItem("madonhang", id);
                                                        console.log(id);
                                                        loadChiTietSanPham(id);
                                       });
        //View pdf hóa đơn
                       $(document).on('click', '.Viewpdf', function () {
                           var id = parseInt(this.getAttribute('data-id'));
                           console.log(id);
                            window.location.href = '/DonHang/XemHoaDon?id=' + id;
                        });

                     // Update
                    $('#Update').click(function () {
                    const madonhang = parseInt($("#tmadonhang").val());
                    const ttvanchuyen = $("#tttvanchuyen").val();
                    const ttthanhtoan = $("#tttthanhtoan").val() === "" ? null : $("#tttthanhtoan").val() === "true";
                    const ngaycapnhat = new Date().toISOString();

                    // Xây URL có query string
                    const url = `http://localhost:7177/DonHang/CapNhat?madonhang=${madonhang}&ttvanchuyen=${encodeURIComponent(ttvanchuyen)}&ttthanhtoan=${ttthanhtoan}&ngaycapnhat=${encodeURIComponent(ngaycapnhat)}`;
                    console.log(url);
                    $.ajax({
                        url: url,
                        type: "PUT",
                        success: function (res) {
                            Swal.fire({
                                title: 'Thành công!',
                                text: res.message,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
                            loadGridData();
                        },
                        error: function (xhr) {
                            Swal.fire({
                                title: 'Thất bại!',
                                text: xhr.responseJSON?.message || 'Đã xảy ra lỗi khi cập nhật đơn hàng.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    });
                });



                     // Search
                                        $('#searchButton').on('click', function () {
                                                        let searchData = {
                                                        trangThaiVanChuyen: $("#strangthaivanchuyen").val() || null,
                                                        ptthanhtoan: parseInt($("#shinhthucvanchuyen").val()) || null,
                                                        trangthaiThanhToan: $("#strangthaithanhtoan").val() === "" ? null : $("#strangthaithanhtoan").val() === "true",
                                                        ngayBatDau: $("#sngaydau").val() || null,
                                                        ngayKetThuc: $("#sngaycuoi").val() || null
                                                        };
                                                        console.log(searchData);
                                                        $.ajax({
                                                        url: 'http://localhost:7177/DonHang/TimKiem',
                                                        method: 'POST',
                                                        contentType: 'application/json',
                                                        data: JSON.stringify(searchData),
                                                         success: function (res) {
                                                                                                              console.log(res);
                                                         $('#listGrid').DataTable({
                                                         dom: '<"top"f>rt<"bottom"ip><"clear">',
                                                         destroy: true,
                                                         lengthChange: true,
                                                         autoWidth: false,
                                                         searching: false,
                                                         ordering: true,
                                                         paging: true,
                                                         data: res.data,
                                                           columns: [
                                                                 { "data": "tenDatMua", "width": "10%" },
                                                                 { "data": "trangThaiVanChuyen", "width": "12%" },
                                                                        {
                  data: "tienGiam",
                  width: "11%",
                  render: function (data, type, row) {
                      let formatted = "";
                    if (!data || !row) return formatted = parseFloat(0.0).toLocaleString("vi-VN", { style: "currency", currency: "VND" });;


                    if (row.loaiGiamGia && row.loaiGiamGia.includes("Giảm theo %")) {
                      const tongTien = row.tongTien || 0;
                      const giam = (data * tongTien) / 100;
                      formatted = giam.toLocaleString("vi-VN", { style: "currency", currency: "VND" });
                    } else if(row.loaiGiamGia && row.loaiGiamGia.includes("Giảm tiền mặt")) {
                      formatted = parseFloat(data).toLocaleString("vi-VN", { style: "currency", currency: "VND" });
                    }
                    else
                    {
                         formatted = parseFloat(data).toLocaleString("vi-VN", { style: "currency", currency: "VND" });
                    }
                    return formatted;
                  }
                },

                                                                 { "data": "thanhTien", "width": "11%",
                                                                  render: function (data, type, row) {
                      let formatted = "";
                     return formatted = parseFloat(data).toLocaleString("vi-VN", { style: "currency", currency: "VND" });
                  }
                                                                 },
                                                                 { "data": "phuongthucthanhtoan", "width": "17%" },
                                                                  {
                                                                     data: "trangThaiThanhToan",
                                                                     width: "15%",
                                                                     render: function (data, type, row) {
                                                                     return data === true ? "Đã thanh toán" : "Chưa thanh toán";
                                                                     }
                                                                 },
                                                                              {
                  data: "ngayTao",  // giữ nguyên kiểu DateTime
                  width: "13%",
                  render: function (data, type, row) {
                    if (!data) return "";

                    // Khi sắp xếp, trả về data gốc để đảm bảo đúng kiểu
                    if (type === "sort" || type === "type") {
                      return data;
                    }

                    const date = new Date(data);
                    const pad = n => n.toString().padStart(2, '0');
                    return pad(date.getDate()) + "/" +
                           pad(date.getMonth() + 1) + "/" +
                           date.getFullYear() + " " +
                           pad(date.getHours()) + ":" +
                           pad(date.getMinutes()) + ":" +
                           pad(date.getSeconds());
                  }
                }
                ,

                                                                 {
                                                                     "data": "maDonHang",
                                                                     "width":"16%",
                                                                     render: function (data) {
                                                                     let editButton = `
                                                                     <button class='ViewDetails btn btn-link' data-id="${data}">
                                                                     <i class="bi bi-pencil-fill"></i>
                                                                     </button>`;

                                                                     let DetailsButton = `
                                                                     <button class='DeleteSubject btn btn-link' data-id="${data}">
                                                                     <i class="bi bi-list"></i>
                                                                     </button>`;
                                                                     let PdfButton = `
                                                                     <button class='Viewpdf btn btn-link' data-id="${data}">
                                                                    <i class="bi bi-file-earmark-pdf-fill"></i>
                                                                     </button>`;
                                                                     return editButton + DetailsButton + PdfButton;
                                                                     }
                                                                     }
                                                 ],
                                                         language: {
                                                         search: "Tìm kiếm:",
                                                         info: "Hiển thị từ _START_ đến _END_ của _TOTAL_ đơn hàng",
                                                         zeroRecords: "Không tìm thấy kết quả nào."
                                                         }
                                                         });
                                                         },
                                                         error: function (err) {
                                                         }
                                                         });
                                     });
                     });
    </script>
}

<style>
    /* Hide default sorting arrows */
    #listGrid thead th {
        cursor: default;
        position: relative;
    }

        /* Hide the sorting arrows */
        #listGrid thead th.sorting:before,
        #listGrid thead th.sorting:after,
        #listGrid thead th.sorting_asc:before,
        #listGrid thead th.sorting_asc:after,
        #listGrid thead th.sorting_desc:before,
        #listGrid thead th.sorting_desc:after {
            display: none;
        }

    #listGrid1 thead th {
        cursor: default;
        position: relative;
    }

        /* Hide the sorting arrows */
        #listGrid1 thead th.sorting:before,
        #listGrid1 thead th.sorting:after,
        #listGrid1 thead th.sorting_asc:before,
        #listGrid1 thead th.sorting_asc:after,
        #listGrid1 thead th.sorting_desc:before,
        #listGrid1 thead th.sorting_desc:after {
            display: none;
        }
    /* Align search bar to the top left */
    .dataTables_filter {
        text-align: center;
    }

    /* Center the pagination controls at the bottom */
    .dataTables_length, .dataTables_filter, .dataTables_paginate {
        text-align: center;
    }
    /* Align custom sort button with search and pagination */
    .dataTables_wrapper .top {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Ưu tiên cao hơn để ghi đè màu mặc định */
    /* Đổi màu khi được chọn (tab active) */
    /* Khi tab được chọn (active), đổi màu nền và màu chữ */
    li.gsm-link-tab > a.custom-tab-link.active {
        background-color: #fdb9a4 !important; /* Màu nền hồng */
        color: #a75851 !important; /* Màu chữ tùy chỉnh */
        border-color: transparent !important;
    }

        /* Đảm bảo không bị ghi đè bởi các quy tắc khác cho màu chữ trong span */
        li.gsm-link-tab > a.custom-tab-link.active span {
            color: #a75851 !important; /* Màu chữ trong span */
        }

    /* Nếu vẫn không được, ghi đè lại trong các tình huống khác */
    li.gsm-link-tab > a.custom-tab-link.active {
        color: #a75851 !important; /* Màu chữ chữ cho tất cả trạng thái */
    }

    .rotating-icon {
        transform: rotate(360deg);
        transform-origin: center center;
        transition: transform 0.5s ease-in-out;
    }
</style>
